flowchart TD
  %% Incident / Observability â€” KPIs + fallbacks + auto-retry

  subgraph FE["Frontend (Next.js)"]
    ev1["emit quiz_intro_shown"]
    ev2["emit quiz_start_clicked"]
    ev3["emit quiz_complete"]
    ev4["emit quiz_cta_clicked"]
  end

  subgraph PH["PostHog Cloud"]
    cap["/capture"]
    dash["Dashboards / Funnels"]
  end

  subgraph OPS["Ops & Alerts"]
    slack["Slack #quiz-alerts"]
    runbook["Runbook steps:\nflags/kill-switch,\ntrigger retries,\nstatus comms"]
  end

  subgraph BE["Edge Functions"]
    leadSync["POST /lead -> Email API"]
    exportJob["Nightly Export -> Storage"]
    infer["/infer -> Model or Stub"]
  end

  subgraph EXT["External Providers"]
    emailAPI["Email Provider API"]
    storage["Supabase Storage"]
  end

  %% Emit events
  ev1 --> cap
  ev2 --> cap
  ev3 --> cap
  ev4 --> cap
  cap --> dash

  %% KPIs
  subgraph KPIs["KPIs (computed in dashboards)"]
    k1["completion_rate = complete / start"]
    k2["bounce_rate = 1 - start / intro"]
    k3["optin_rate = leads / complete"]
    k4["avg_intent_confidence (p50/p90)"]
    k5["infer_success_rate"]
    k6["latency_p95"]
  end
  dash --> KPIs

  %% Thresholds -> Slack
  subgraph TH["Thresholds"]
    t1["completion_rate < 0.35"]
    t2["bounce_rate > 0.55"]
    t3["optin_rate < 0.10"]
    t4["latency_p95 > 1500ms"]
    t5["infer_success_rate < 0.9"]
  end
  KPIs --> TH --> slack

  %% BE -> providers
  leadSync --> emailAPI
  exportJob --> storage

  %% Fallbacks
  cap -->|5xx/timeout| phFail["PH fail -> queue local"]
  emailAPI -->|fail/timeout| mailFail["set synced=false"]
  storage -->|fail/space| expFail["export failed"]

  %% Auto-retry crons
  phFail --> cronPH["auto-retry: cron_ph_flush"] --> cap
  mailFail --> cronLead["auto-retry: cron_leads_retry"] --> emailAPI
  expFail --> cronExp["auto-retry: cron_export_retry"] --> storage

  %% ML infer fallback metric path
  infer --> k5

  %% Runbook path
  slack --> runbook
