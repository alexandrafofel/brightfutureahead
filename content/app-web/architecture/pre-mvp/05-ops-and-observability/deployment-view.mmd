flowchart LR
  %% Deployment View â€” with queues & self-healing crons

  subgraph client["User Device"]
    ua["Mobile Browser"]
  end

  subgraph cdn["Vercel Edge / CDN"]
    vercel["Next.js static/ISR"]
  end

  subgraph supa["Supabase Project"]
    edge["Edge Functions\n/quiz, /lead, /infer, /feedback"]
    pg["Postgres DB"]
    store["Storage exports/"]
    auth["Auth (anon vs service role)"]
    cron_exp["cron_export_retry"]
    cron_mail["cron_leads_retry"]
    cron_ph["cron_ph_flush"]
    cron_ml["cron_ml_retry"]
  end

  subgraph analytics["PostHog Cloud"]
    cap["/capture"]
  end

  subgraph email["Email Provider"]
    mail["addContact API"]
  end

  subgraph queues["Fallback Queues"]
    q_ph["q_ph (events when PH down)"]
    q_mail["LEADS.synced=false"]
    q_exp["export retry queue"]
    q_ml["q_ml (infer retry)"]
  end

  ua --> vercel
  vercel --> edge
  edge --> pg
  edge -. service role .- auth
  vercel -. anon jwt .- auth

  %% Analytics path
  vercel -. whitelist events .-> cap
  cap -->|5xx/timeout| q_ph
  q_ph --> cron_ph --> cap

  %% Leads path
  edge --> mail
  mail -->|fail/timeout| q_mail
  q_mail --> cron_mail --> mail

  %% Exports
  edge --> store
  store -->|fail/space| q_exp
  q_exp --> cron_exp --> store

  %% ML infer
  edge --> q_ml
  q_ml --> cron_ml --> edge

  %% DB relation
  edge --> pg
